'use strict';

var isHotKey = require('is-hotkey').default;
var TablePosition = require('../utils/TablePosition');
var moveSelectionBy = require('../changes/moveSelectionBy');
var insertRow = require('../changes/insertRow');

/**
 * Select all text of current block.
 * @param {Slate.Transform} change
 * @return {Slate.Transform}
 */
function selectAllText(change) {
  var value = change.value;
  var startBlock = value.startBlock;


  return change.moveOffsetsTo(0).extend(startBlock.text.length);
}

/**
 * Pressing "Tab" moves the cursor to the next cell
 * and select the whole text
 */
function onTab(event, change, opts) {
  event.preventDefault();
  var direction = isHotKey('shift+tab', event) ? -1 : +1;
  var _change = change,
      value = _change.value;


  if (opts.isTabCreateRow) {
    // Create new row if needed
    var startBlock = value.startBlock;

    var pos = TablePosition.create(change, startBlock);
    if (pos.isFirstCell() && direction === -1) {
      insertRow(opts, change, 0);
    } else if (pos.isLastCell() && direction === 1) {
      insertRow(opts, change);
    }
  }

  // Move
  change = moveSelectionBy(opts, change, direction, 0);

  // Select all cell.
  return selectAllText(change);
}

module.exports = onTab;